<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Visitor Form</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Poppins:wght@300;400;600&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }

        .form-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .form-scroll::-webkit-scrollbar-thumb {
            background-color: #bbb;
            border-radius: 4px;
        }

        .form-scroll::-webkit-scrollbar-track {
            background-color: #eee;
        }

        label {
            min-width: 160px;
        }

        .btn-outline-primary {
            border: 1px solid #4361ee;
            color: #4361ee;
            background-color: transparent;
            padding: 0.5rem 1.5rem;
            transition: all 0.3s ease;
        }

        .btn-outline-primary:hover {
            background-color: #4361ee;
            color: white;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
        }

        .error {
            margin-top: 4px;
            color: #dc3545;
            font-size: 12px;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            box-shadow: 0 0 0 1px #4361ee;
            border-color: #4361ee;
        }

        /* Hide default file input */
        input[type="file"] {
            display: none;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        /* Modal styles for photo selection */
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            width: 300px;
        }
 
        .modal-content button {
            margin: 10px;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
 
        .modal-content .gallery-btn {
            color: #4361ee;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            outline: 1px solid #4361ee; /* Added outline */
                   /* Optional: adds space between button edge and outline */
        }
        .modal-content .gallery-btn:hover {
            background-color: #4361ee;
            color: #fff;
        }
 
        .modal-content .camera-btn {
            color: #16a34a;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            outline: 1px solid #16a34a;
        }
        .modal-content .camera-btn:hover {
            background-color: #16a34a;
            color: #fff;
        }
 
        .modal-content .close-btn {
            color: #dc3545;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            outline: 1px solid #dc3545
        }
        .modal-content .close-btn:hover {
            background-color: #dc3545;
            color: #fff;
        }


    </style>
</head>

<body class="bg-gray-100">
    <div class="h-l flex items-center justify-center p-4">
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
            <div class="w-full max-w-5xl h-full bg-white rounded-lg shadow-md overflow-hidden flex flex-col">
                <div class="px-6 py-4 border-b text-xl font-semibold text-center"
                    style="font-family: 'Nunito', sans-serif;">
                    Visitor Registration Form
                </div>
                <form id="visitorForm" class="flex-1 overflow-y-auto p-6 space-y-4 form-scroll">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="flex sm:flex-row flex-col items-center">
                            <label for="firstname" class="sm:mb-0 mb-1 sm:mr-2 text-sm font-medium">First Name</label>
                            <div class="form-group">
                                <input type="text" id="firstname" name="firstname" placeholder="Enter first name"
                                    class="w-full text-xs px-3 py-2 border rounded" />
                                <span class="error text-xs text-red-500" id="error-firstname"></span>
                            </div>
                        </div>

                        <div class="flex sm:flex-row flex-col items-center">
                            <label for="lastname" class="sm:mb-0 mb-1 sm:mr-2 text-sm font-medium">Last Name</label>
                            <div class="form-group">
                                <input type="text" id="lastname" name="lastname" placeholder="Enter last name"
                                    class="w-full text-xs px-3 py-2 border rounded" />
                                <span class="error text-xs text-red-500" id="error-lastname"></span>
                            </div>
                        </div>

                        <div class="flex sm:flex-row flex-col items-center">
                            <label for="gender" class="sm:mb-0 mb-1 sm:mr-2 text-sm font-medium">Gender</label>
                            <div class="form-group">
                                <select id="gender" name="gender" class="w-full text-xs px-3 py-2 border rounded">
                                    <option value="">Select gender</option>
                                    <option>Male</option>
                                    <option>Female</option>
                                    <option>Other</option>
                                </select>
                                <span class="error text-xs text-red-500" id="error-gender"></span>
                            </div>
                        </div>

                        <div class="flex sm:flex-row flex-col items-center">
                            <label for="contactnumber" class="sm:mb-0 mb-1 sm:mr-2 text-sm font-medium">Contact
                                Number</label>
                            <div class="form-group">
                                <input type="text" id="contactnumber" name="contactnumber"
                                    placeholder="Enter contact number"
                                    class="w-full text-xs px-3 py-2 border rounded" />
                                <span class="error text-xs text-red-500" id="error-contactnumber"></span>
                            </div>
                        </div>

                        <div class="flex sm:flex-row flex-col items-center">
                            <label for="email" class="sm:mb-0 mb-1 sm:mr-2 text-sm font-medium">Email Address</label>
                            <div class="form-group">
                                <input type="email" id="email" name="email" placeholder="Enter email address"
                                    class="w-full text-xs px-3 py-2 border rounded" />
                                <span class="error text-xs text-red-500" id="error-email"></span>
                            </div>
                        </div>

                        <div class="flex sm:flex-row flex-col items-center">
                            <label for="date" class="sm:mb-0 mb-1 sm:mr-2 text-sm font-medium">Date</label>
                            <div class="form-group">
                                <input type="date" id="date" name="date"
                                    class="w-full text-xs px-3 py-2 border rounded" />
                                <span class="error text-xs text-red-500" id="error-date"></span>
                            </div>
                        </div>

                        <div class="flex sm:flex-row flex-col items-center">
                            <label for="time" class="sm:mb-0 mb-1 sm:mr-2 text-sm font-medium">Time</label>
                            <div class="form-group">
                                <input type="time" id="time" name="time"
                                    class="w-full text-xs px-3 py-2 border rounded" />
                                <span class="error text-xs text-red-500" id="error-time"></span>
                            </div>
                        </div>

                        <div class="flex sm:flex-row flex-col items-center">
                            <label for="nationalid" class="sm:mb-0 mb-1 sm:mr-2 text-sm font-medium">National ID</label>
                            <div class="form-group">
                              <input type="text" id="nationalid" name="nationalid" placeholder="Enter national ID"
                                class="w-full text-xs px-3 py-2 border rounded" />
                              <span class="error text-xs text-red-500" id="error-nationalid"></span>
                            </div>
                          </div>

                        <div class="flex sm:flex-row flex-col items-center">
                            <label for="photo" class="sm:mb-0 mb-1 sm:mr-2 text-sm font-medium">Photo</label>
                            <div class="form-group">
                                <input type="file" id="photo" name="photo" accept="image/*"
                                    onchange="previewImage(this, 'mainPreview')" />
                                <button type="button" class="w-full text-xs px-3 py-2 border rounded"
                                    onclick="showModal('photo')">Choose Photo</button>
                                <span class="error text-xs text-red-500" id="error-photo"></span>
                                <div class="sm:col-span-2">
                                    <img id="mainPreview" class="w-24 h-16 rounded border hidden" />
                                </div>
                            </div>
                        </div>

                        <div class="flex sm:flex-row flex-col items-center">
                            <label for="visit" class="sm:mb-0 mb-1 sm:mr-2 text-sm font-medium">Purpose of Visit</label>
                            <div class="form-group">
                                <input type="text" id="visit" name="visit" placeholder="Enter visit purpose"
                                    class="w-full text-xs px-3 py-2 border rounded" />
                                <span class="error text-xs text-red-500" id="error-visit"></span>
                            </div>
                        </div>

                        <div class="flex sm:flex-row flex-col items-center">
                            <label for="personname" class="sm:mb-0 mb-1 sm:mr-2 text-sm font-medium">Person Name</label>
                            <div class="form-group">
                                <input type="text" id="personname" name="personname"
                                    placeholder="Enter name of person to meet"
                                    class="w-full text-xs px-3 py-2 border rounded" />
                                <span class="error text-xs text-red-500" id="error-personname"></span>
                            </div>
                        </div>

                        <div class="flex sm:flex-row flex-col items-center">
                            <label for="department" class="sm:mb-0 mb-1 sm:mr-2 text-sm font-medium">Department</label>
                            <div class="form-group">
                                <input type="text" id="department" name="department"
                                    placeholder="Enter the visiting department"
                                    class="w-full text-xs px-3 py-2 border rounded" />
                                <span class="error text-xs text-red-500" id="error-department"></span>
                            </div>
                        </div>

                        <div class="flex sm:flex-row flex-col items-center max-w-md w-full">
                            <label for="durationtime" class="sm:mb-0 mb-1 sm:mr-2 text-sm font-medium w-32">
                                Expected Duration
                            </label>
                            <div class="form-group flex sm:flex-row flex-col sm:space-x-2 space-y-2 sm:space-y-0 w-full">
                                <!-- Duration Unit Select -->
                                <div class="w-full sm:w-1/3">
                                    <select id="durationUnit" name="durationUnit"
                                        class="w-full text-xs px-3 py-2 border rounded">
                                        <option value="">Select unit</option>
                                        <option value="Hours">Hours</option>
                                        <option value="Minutes">Minutes</option>
                                        <option value="Days">Days</option>
                                    </select>
                                </div>
                        
                                <!-- Duration Time Input -->
                                <div class="w-full sm:w-2/3">
                                    <input type="number" id="durationtime" name="durationtime"
                                        placeholder="Enter expected duration"
                                        class="w-full text-xs px-3 py-2 border rounded" min="1" />
                                    <!-- Correctly positioned error message -->
                                    <span class="error text-xs text-red-500 mt-1 block" id="error-durationtime"></span>
                                </div>
                            </div>
                        </div>                          



                        <div class="flex sm:flex-row flex-col items-center">
                            <label for="visitortype" class="sm:mb-0 mb-1 sm:mr-2 text-sm font-medium">Visitor
                                Type</label>
                            <div class="form-group">
                                <select id="visitortype" name="visitortype"
                                    class="w-full text-xs px-3 py-2 border rounded">
                                    <option value="">Select visitor type</option>
                                    <option>Vendor</option>
                                    <option>Client</option>
                                    <option>Interview</option>
                                    <option>Guest</option>
                                </select>
                                <span class="error text-xs text-red-500" id="error-visitortype"></span>
                            </div>
                        </div>

                        <div class="flex sm:flex-row flex-col items-center">
                            <label for="vehicletype" class="sm:mb-0 mb-1 sm:mr-2 text-sm font-medium">Vehicle
                                Type</label>
                            <div class="form-group">
                                <input type="text" id="vehicletype" name="vehicletype" placeholder="Enter vehicle type"
                                    class="w-full text-xs px-3 py-2 border rounded" />
                                <span class="error text-xs text-red-500" id="error-vehicletype"></span>
                            </div>
                        </div>

                        <div class="flex sm:flex-row flex-col items-center">
                            <label for="vehiclenumber" class="sm:mb-0 mb-1 sm:mr-2 text-sm font-medium">Vehicle
                                Number</label>
                            <div class="form-group">
                                <input type="text" id="vehiclenumber" name="vehiclenumber"
                                    placeholder="Enter vehicle number"
                                    class="w-full text-xs px-3 py-2 border rounded" />
                                <span class="error text-xs text-red-500" id="error-vehiclenumber"></span>
                            </div>
                        </div>

                        <div class="flex sm:flex-row flex-col items-center sm:col-span-2">
                            <label class="sm:mr-2 text-sm font-medium">Include Driver?</label>
                            <input type="checkbox" id="driverToggle" onchange="toggleDriverDetails()" />
                        </div>
                    </div>

                    <div id="driverDetails" class="hidden mt-4 space-y-4 border-t pt-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="flex sm:flex-row flex-col items-center">
                                <label for="drivername" class="sm:mb-0 mb-1 sm:mr-2 text-sm font-medium">Driver
                                    Name</label>
                                <div class="form-group">
                                    <input type="text" id="drivername" name="drivername" placeholder="Enter driver name"
                                        class="w-full text-xs px-3 py-2 border rounded" />
                                    <span class="error text-xs text-red-500" id="error-drivername"></span>
                                </div>
                            </div>
                            <div class="flex sm:flex-row flex-col items-center">
                                <label for="drivermobile" class="sm:mb-0 mb-1 sm:mr-2 text-sm font-medium">Driver
                                    Mobile</label>
                                <div class="form-group">
                                    <input type="text" id="drivermobile" name="drivermobile"
                                        placeholder="Enter driver mobile"
                                        class="w-full text-xs px-3 py-2 border rounded" />
                                    <span class="error text-xs text-red-500" id="error-drivermobile"></span>
                                </div>
                            </div>
                            <div class="flex sm:flex-row flex-col items-center">
                                <label for="drivernationalid" class="sm:mb-0 mb-1 sm:mr-2 text-sm font-medium">Driver
                                    National ID</label>
                                <div class="form-group">
                                    <input type="text" id="drivernationalid" name="drivernationalid"
                                        placeholder="Enter driver national ID"
                                        class="w-full text-xs px-3 py-2 border rounded" />
                                    <span class="error text-xs text-red-500" id="error-drivernationalid"></span>
                                </div>
                            </div>
                            <div class="flex sm:flex-row flex-col items-center">
                                <label for="driverphoto" class="sm:mb-0 mb-1 sm:mr-2 text-sm font-medium">Driver
                                    Photo</label>
                                <div class="form-group">
                                    <input type="file" id="driverphoto" name="driverphoto" accept="image/*"
                                        onchange="previewImage(this, 'driverPreview')" />
                                    <button type="button" class="w-full text-xs px-3 py-2 border rounded"
                                        onclick="showModal('driverphoto')">Choose Photo</button>
                                    <span class="error text-xs text-red-500" id="error-driverphoto"></span>
                                    <div class="sm:col-span-2">
                                        <img id="driverPreview" class="w-24 h-16 rounded border hidden" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex sm:flex-row flex-col items-center">
                        <label for="notes" class="sm:mb-0 mb-1 sm:mr-2 text-sm font-medium">Notes</label>
                        <div class="form-group">
                            <textarea id="notes" name="notes" rows="1" placeholder="Enter any notes..."
                                class="w-full text-xs px-3 py-2 border rounded"></textarea>
                            <span class="error text-xs text-red-500" id="error-notes"></span>
                        </div>
                    </div>

                    <div class="flex justify-end mt-6">
                        <button type="submit" id="submitBtn" class="btn-outline-primary rounded-full text-sm">Submit</button>
                      </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal for Gallery/Camera selection -->
    <div id="photoModal" class="modal">
        <div class="modal-content">
            <h3>Select Photo Source</h3>
            <button class="gallery-btn" onclick="openGallery()">Gallery</button>
            <button class="camera-btn" onclick="openCamera()">Camera</button>
            <button class="close-btn" onclick="closeModal()">Close</button>
        </div>
    </div>

    <!-- Hidden video element for camera preview -->
    <video id="cameraPreview" style="display: none;"></video>
    <canvas id="cameraCanvas" style="display: none;"></canvas>



    <script>
        // Visitor Form Logic
        let currentFileInputId = '';
      
        function showModal(fileInputId) {
          currentFileInputId = fileInputId;
          const modal = document.getElementById('photoModal');
          if (modal) modal.style.display = 'flex';
        }
      
        function closeModal() {
          const modal = document.getElementById('photoModal');
          if (modal) modal.style.display = 'none';
          stopCamera();
        }
      
        function openGallery() {
          const fileInput = document.getElementById(currentFileInputId);
          if (fileInput) {
            fileInput.removeAttribute('capture');
            fileInput.click();
          }
          closeModal();
        }
      
        function openCamera() {
          const fileInput = document.getElementById(currentFileInputId);
          if (fileInput) {
            fileInput.setAttribute('capture', 'environment');
            fileInput.click();
          }
          closeModal();
        }
      
        function startCamera(fileInput) {
          const video = document.getElementById('cameraPreview');
          const canvas = document.getElementById('cameraCanvas');
          if (!video || !canvas) return;
          navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(stream => {
              video.srcObject = stream;
              video.style.display = 'block';
              video.play();
              const captureBtn = document.createElement('button');
              captureBtn.textContent = 'Capture Photo';
              captureBtn.className = 'btn-outline-primary';
              captureBtn.onclick = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                canvas.toBlob(blob => {
                  const file = new File([blob], 'camera-photo.jpg', { type: 'image/jpeg' });
                  const dataTransfer = new DataTransfer();
                  dataTransfer.items.add(file);
                  fileInput.files = dataTransfer.files;
                  fileInput.dispatchEvent(new Event('change'));
                  stopCamera();
                }, 'image/jpeg');
              };
              document.body.appendChild(captureBtn);
            })
            .catch(err => {
              console.error('Camera access denied:', err);
              showError('error-' + currentFileInputId, 'Unable to access camera');
            });
        }
      
        function stopCamera() {
          const video = document.getElementById('cameraPreview');
          if (video && video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
            video.style.display = 'none';
          }
          const captureBtn = document.querySelector('button[onclick*="capture"]');
          if (captureBtn) captureBtn.remove();
        }
      
        function previewImage(input, id) {
          const file = input.files[0];
          const img = document.getElementById(id);
          if (file && img) {
            const reader = new FileReader();
            reader.onload = e => {
              img.src = e.target.result;
              img.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
          } else if (img) {
            img.classList.add('hidden');
          }
        }
      
        function toggleDriverDetails() {
          const driverDetails = document.getElementById('driverDetails');
          if (driverDetails) driverDetails.classList.toggle('hidden');
        }
      
        function showError(id, msg) {
          const element = document.getElementById(id);
          if (element) element.innerText = msg;
        }
      
        function clearErrors() {
          document.querySelectorAll('.error').forEach(el => el.innerText = '');
        }
      
        const validateField = (name, value, formData = {}) => {
          let error = '';
          const requiredFields = [
            'firstname', 'lastname', 'gender', 'contactnumber', 'email',
            'date', 'time', 'nationalid', 'photo', 'visit', 'personname',
            'department', 'durationtime', 'visitortype'
          ];
          if (requiredFields.includes(name) && !value && name !== 'photo') {
            error = `${name.charAt(0).toUpperCase() + name.slice(1).replace(/([A-Z])/g, ' $1')} is required`;
          } else if (name === 'photo' && !document.getElementById(name)?.files.length) {
            error = 'Photo is required';
          }
          switch (name) {
            case 'firstname':
            case 'lastname':
              if (value && !/^[a-zA-Z\s]{2,}$/.test(value)) {
                error = `${name === 'firstname' ? 'First' : 'Last'} name must be at least 2 characters and contain only letters`;
              }
              break;
            case 'personname':
              if (value && !/^[a-zA-Z\s]{2,}$/.test(value)) {
                error = 'Person name must be at least 2 characters and contain only letters';
              }
              break;
            case 'drivername':
              if (value && !/^[a-zA-Z\s]{2,}$/.test(value)) {
                error = 'Driver name must be at least 2 characters and contain only letters';
              }
              break;
            case 'contactnumber':
              if (value && !/^\d+$/.test(value)) {
                error = 'Phone number must contain only digits';
              }
              break;
            case 'drivermobile':
              if (value && !/^\d+$/.test(value)) {
                error = 'Phone number must contain only digits';
              }
              break;
            case 'nationalid':
            case 'drivernationalid':
              if (value && !/^[a-zA-Z0-9]{4,}$/.test(value)) {
                error = 'National ID must be at least 4 characters (letters and numbers allowed)';
              }
              break;
            case 'email':
              if (value && !/^[\w-.]+@([\w-]+\.)+[\w-]{2,4}$/.test(value)) {
                error = 'Please enter a valid email address';
              }
              break;
            case 'gender':
              if (!value) error = 'Please select a gender';
              break;
            case 'visitortype':
              if (!value) error = 'Please select a visitor type';
              break;
            case 'time':
              if (value && formData.date) {
                const selectedDate = new Date(formData.date);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                selectedDate.setHours(0, 0, 0, 0);
                if (selectedDate.getTime() === today.getTime()) {
                  const [hours, minutes] = value.split(':').map(Number);
                  const now = new Date();
                  if (hours < now.getHours() || (hours === now.getHours() && minutes <= now.getMinutes())) {
                    error = 'Allocation time cannot be in the past for today';
                  }
                }
              }
              break;
            case 'durationtime':
              if (value && !/^\d+$/.test(value)) {
                error = 'Duration must be a positive number';
              }
              break;
            case 'date':
              if (value) {
                const selectedDate = new Date(value);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                if (selectedDate < today) {
                  error = 'Date must be today or later';
                }
              }
              break;
          }
          return error;
        };
      
        const attachLiveValidation = () => {
          document.querySelectorAll('input, select, textarea').forEach(input => {
            input.addEventListener('input', () => {
              const formData = {
                date: document.getElementById('date')?.value,
                time: document.getElementById('time')?.value
              };
              const error = validateField(input.id, input.value, formData);
              showError('error-' + input.id, error);
            });
          });
        };
      
        async function checkFormStatus(email, date, time) {
          try {
            const response = await fetch(
              `http://192.168.3.73:3001/appointment/check-status?email=${encodeURIComponent(email)}&date=${encodeURIComponent(date)}&time=${encodeURIComponent(time)}`,
              {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
              }
            );
            if (!response.ok) throw new Error(`Failed to check form status: ${response.statusText}`);
            const { isFormCompleted } = await response.json();
            return isFormCompleted;
          } catch (error) {
            console.error('Error checking form status:', error);
            return false;
          }
        }
      
        async function initializeForm() {
          const urlParams = new URLSearchParams(window.location.search);
          const fields = ['firstname', 'lastname', 'gender', 'contactnumber', 'email', 'date', 'time'];
          const cleanedParams = {};
          fields.forEach(field => {
            let value = urlParams.get(field) || '';
            value = decodeURIComponent(value.replace(/^,+/, ''));
            cleanedParams[field] = value;
          });
      
          const email = cleanedParams.email;
          const date = cleanedParams.date;
          const time = cleanedParams.time;
      
          if (email && date && time) {
            const isFormCompleted = await checkFormStatus(email, date, time);
            if (isFormCompleted) {
              const formContainer = document.querySelector('.absolute.top-1/2');
              if (formContainer) {
                formContainer.innerHTML = `
                  <div class="w-full max-w-5xl bg-white rounded-lg shadow-md p-6 text-center">
                    <h2 class="text-xl font-semibold mb-4" style="font-family: 'Nunito', sans-serif;">Form Already Submitted</h2>
                    <p class="text-sm text-gray-600">You have submitted form already.</p>
                  </div>
                `;
              }
              return;
            }
          }
      
          fields.forEach(field => {
            const input = document.getElementById(field);
            if (input) {
              let value = cleanedParams[field];
              if (value) {
                if (field === 'time') {
                  value = value.split(':').slice(0, 2).join(':');
                  if (!/^\d{2}:\d{2}$/.test(value)) value = '';
                }
                if (field === 'gender') {
                  value = value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
                  if (!['Male', 'Female', 'Other'].includes(value)) value = '';
                }
                input.value = value;
                input.disabled = true;
              }
            }
          });
      
          const form = document.getElementById('visitorForm');
          const submitBtn = document.getElementById('submitBtn');
          if (!form || !submitBtn) return;
    
      
          let loading = false;
      
          form.addEventListener('submit', async e => {
            e.preventDefault();
            if (loading) return;
      
            clearErrors();
            let valid = true;
      
            const get = id => document.getElementById(id)?.value.trim() || '';
            const fieldsToValidate = [
              'firstname', 'lastname', 'gender', 'contactnumber', 'email',
              'date', 'time', 'nationalid', 'photo', 'visit', 'personname',
              'department', 'durationtime', 'visitortype', 'vehicletype',
              'vehiclenumber', 'drivername', 'drivermobile', 'drivernationalid', 'driverphoto'
            ];
      
            const formData = { date: get('date'), time: get('time') };
      
            fieldsToValidate.forEach(id => {
              const value = id === 'photo' || id === 'driverphoto' ? document.getElementById(id)?.files[0] : get(id);
              const errorMsg = validateField(id, value, formData);
              if (errorMsg) {
                showError('error-' + id, errorMsg);
                valid = false;
              }
            });
      
            const photo = document.getElementById('photo')?.files[0];
            if (!photo || !/\.(jpg|jpeg|png)$/i.test(photo.name)) {
              showError('error-photo', 'Upload .jpg/.png image');
              valid = false;
            }
      
        
      
            const driverToggle = document.getElementById('driverToggle')?.checked;
            if (driverToggle) {
              const dName = get('drivername');
              const dMob = get('drivermobile');
              const dNid = get('drivernationalid');
              const dPhoto = document.getElementById('driverphoto')?.files[0];
      
              if (!/^[A-Za-z\s]{2,50}$/.test(dName)) {
                showError('error-drivername', 'Enter valid driver name');
                valid = false;
              }
              if (!/^\d{5,15}$/.test(dMob)) {
                showError('error-drivermobile', 'Enter valid mobile');
                valid = false;
              }
              if (!/^[a-zA-Z0-9]{4,}$/.test(dNid)) {
                showError('error-drivernationalid', 'Enter valid ID');
                valid = false;
              }
              if (!dPhoto || !/\.(jpg|jpeg|png)$/i.test(dPhoto.name)) {
                showError('error-driverphoto', 'Upload driver image');
                valid = false;
              }
            }
      
            const notes = get('notes');
            if (notes.length > 500 || /<script/i.test(notes)) {
              showError('error-notes', 'Invalid notes content');
              valid = false;
            }
      
            if (!valid) {
              errorMessage.textContent = 'Please fix the errors above.';
              errorMessage.classList.remove('hidden');
              return;
            }
      
            loading = true;
            submitBtn.textContent = 'Submitting...';
            submitBtn.disabled = true;
      
            const formattedData = new FormData();
            form.querySelectorAll('input:not([type="checkbox"]), select, textarea').forEach(input => {
              if (input.type === 'file' && input.files[0]) {
                formattedData.append(input.name, input.files[0]);
              } else if (!input.disabled) {
                formattedData.append(input.name, input.value || '');
              }
            });
      
            fields.forEach(field => {
              const input = document.getElementById(field);
              if (input) formattedData.append(field, input.value || '');
            });
      
            console.log('ðŸ“¤ Submitting FormData:');
            for (const [key, value] of formattedData.entries()) {
              console.log(`  ${key}: ${value instanceof File ? value.name : value}`);
            }
      
            try {
              const response = await fetch('http://192.168.3.73:3001/appointment/create', {
                method: 'POST',
                body: formattedData
              });
      
              if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to submit form. Please try again.');
              }
      
              const formContainer = document.querySelector('.absolute.top-1/2');
              if (formContainer) {
                formContainer.innerHTML = `
                  <div class="w-full max-w-5xl bg-white rounded-lg shadow-md p-6 text-center">
                    <h2 class="text-xl font-semibold mb-4" style="font-family: 'Nunito', sans-serif;">Submission Successful</h2>
                    <p class="text-sm text-gray-600">Your visitor registration has been submitted successfully.</p>
                  </div>
                `;
              }
            } catch (error) {
              errorMessage.textContent = error.message;
              errorMessage.classList.remove('hidden');
            } finally {
              loading = false;
              submitBtn.textContent = 'Submit';
              submitBtn.disabled = false;
            }
          });
      
          window.toggleDriverDetails = toggleDriverDetails;
          window.previewImage = previewImage;
          window.showModal = showModal;
      
          attachLiveValidation();
        }
      
        // Alpine.js Logic
        document.addEventListener('alpine:init', () => {
          Alpine.data('scrollToTop', () => ({
            showTopButton: false,
            init() {
              window.onscroll = () => {
                this.scrollFunction();
              };
            },
            scrollFunction() {
              if (document.body.scrollTop > 50 || document.documentElement.scrollTop > 50) {
                this.showTopButton = true;
              } else {
                this.showTopButton = false;
              }
            },
            goToTop() {
              document.body.scrollTop = 0;
              document.documentElement.scrollTop = 0;
            }
          }));
      
          Alpine.data('customizer', () => ({
            showCustomizer: false
          }));
      
          Alpine.data('sidebar', () => ({
            init() {
              const selector = document.querySelector('.sidebar ul a[href="' + window.location.pathname + '"]');
              if (selector) {
                selector.classList.add('active');
                const ul = selector.closest('ul.sub-menu');
                if (ul) {
                  let ele = ul.closest('li.menu').querySelectorAll('.nav-link');
                  if (ele) {
                    ele = ele[0];
                    setTimeout(() => {
                      ele.click();
                    });
                  }
                }
              }
            }
          }));
      
          Alpine.data('header', () => ({
            init() {
              const selector = document.querySelector('ul.horizontal-menu a[href="' + window.location.pathname + '"]');
              if (selector) {
                selector.classList.add('active');
                const ul = selector.closest('ul.sub-menu');
                if (ul) {
                  let ele = ul.closest('li.menu').querySelectorAll('.nav-link');
                  if (ele) {
                    ele = ele[0];
                    setTimeout(() => {
                      ele.classList.add('active');
                    });
                  }
                }
              }
            },
            notifications: [
              { id: 1, profile: 'user-profile.jpeg', message: '<strong class="text-sm mr-1">John Doe</strong>invite you to <strong>Prototyping</strong>', time: '45 min ago' },
              { id: 2, profile: 'profile-34.jpeg', message: '<strong class="text-sm mr-1">Adam Nolan</strong>mentioned you to <strong>UX Basics</strong>', time: '9h Ago' },
              { id: 3, profile: 'profile-16.jpeg', message: '<strong class="text-sm mr-1">Anna Morgan</strong>Upload a file', time: '9h Ago' }
            ],
            messages: [
              {
                id: 1,
                image: '<span class="grid place-content-center w-9 h-9 rounded-full bg-success-light dark:bg-success text-success dark:text-success-light"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg></span>',
                title: 'Congratulations!',
                message: 'Your OS has been updated.',
                time: '1hr'
              },
              {
                id: 2,
                image: '<span class="grid place-content-center w-9 h-9 rounded-full bg-info-light dark:bg-info text-info dark:text-info-light"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg></span>',
                title: 'Did you know?',
                message: 'You can switch between artboards.',
                time: '2hr'
              },
              {
                id: 3,
                image: '<span class="grid place-content-center w-9 h-9 rounded-full bg-danger-light dark:bg-danger text-danger dark:text-danger-light"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></span>',
                title: 'Something went wrong!',
                message: 'Send Reposrt',
                time: '2days'
              },
              {
                id: 4,
                image: '<span class="grid place-content-center w-9 h-9 rounded-full bg-warning-light dark:bg-warning text-warning dark:text-warning-light"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">    <circle cx="12" cy="12" r="10"></circle>    <line x1="12" y1="8" x2="12" y2="12"></line>    <line x1="12" y1="16" x2="12.01" y2="16"></line></svg></span>',
                title: 'Warning',
                message: 'Your password strength is low.',
                time: '5days'
              }
            ],
            languages: [
              { id: 1, key: 'Chinese', value: 'zh' },
              { id: 2, key: 'Danish', value: 'da' },
              { id: 3, key: 'English', value: 'en' },
              { id: 4, key: 'French', value: 'fr' },
              { id: 5, key: 'German', value: 'de' },
              { id: 6, key: 'Greek', value: 'el' },
              { id: 7, key: 'Hungarian', value: 'hu' },
              { id: 8, key: 'Italian', value: 'it' },
              { id: 9, key: 'Japanese', value: 'ja' },
              { id: 10, key: 'Polish', value: 'pl' },
              { id: 11, key: 'Portuguese', value: 'pt' },
              { id: 12, key: 'Russian', value: 'ru' },
              { id: 13, key: 'Spanish', value: 'es' },
              { id: 14, key: 'Swedish', value: 'sv' },
              { id: 15, key: 'Turkish', value: 'tr' },
              { id: 16, key: 'Arabic', value: 'ae' }
            ],
            removeNotification(value) {
              this.notifications = this.notifications.filter(d => d.id !== value);
            },
            removeMessage(value) {
              this.messages = this.messages.filter(d => d.id !== value);
            }
          }));
        });
      
        // Initialize form after DOM content is loaded
        document.addEventListener('DOMContentLoaded', initializeForm);
      </script>
    
</body>

</html>
